{"tags":[{"name":"踩坑日记","permalink":"http://catlittlechen.com/tags/踩坑日记/","url":"/async/tags/踩坑日记.json","count":11},{"name":"golang","permalink":"http://catlittlechen.com/tags/golang/","url":"/async/tags/golang.json","count":3}],"categories":[{"name":"golang","permalink":"http://catlittlechen.com/categories/golang/","url":"/async/categories/golang.json","count":3}],"url":"/async/posts/2015/11/20/记一次debug的坑.json","date":1447991820000,"path":{"year":2015,"month":11,"day":20,"name":"记一次debug的坑"},"title":"记一次debug的坑","permalink":"http://catlittlechen.com/2015/11/20/记一次debug的坑/","content":"<h2 id=\"u611F_u609F\"><a href=\"#u611F_u609F\" class=\"headerlink\" title=\"感悟\"></a>感悟</h2><p>这个故事告诉我们，永远不要相信自己的眼睛。</p>\n<h2 id=\"u90A3_u5929\"><a href=\"#u90A3_u5929\" class=\"headerlink\" title=\"那天\"></a>那天</h2><p>天气晴朗，阳光明媚~<br>我用Go写了一段程序，程序中需要通过从文件中读取一段文字，然后拼入sql中，然后在数据库中执行。</p>\n<p>由于我需要从文件中一行一行的读出数据，我用了这样子的方式读取。</p>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div><div class=\"line\">12</div><div class=\"line\">13</div><div class=\"line\">14</div><div class=\"line\">15</div><div class=\"line\">16</div><div class=\"line\">17</div><div class=\"line\">18</div><div class=\"line\">19</div><div class=\"line\">20</div><div class=\"line\">21</div><div class=\"line\">22</div><div class=\"line\">23</div><div class=\"line\">24</div><div class=\"line\">25</div><div class=\"line\">26</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"function\"><span class=\"keyword\">func</span> <span class=\"title\">readLines</span><span class=\"params\">(path <span class=\"keyword\">string</span>)</span> <span class=\"params\">(lines []<span class=\"keyword\">string</span>, err error)</span></span> &#123;</div><div class=\"line\">       <span class=\"keyword\">var</span> (</div><div class=\"line\">           file   *os.File</div><div class=\"line\">           part   []<span class=\"keyword\">byte</span></div><div class=\"line\">           prefix <span class=\"keyword\">bool</span></div><div class=\"line\">       )</div><div class=\"line\">       <span class=\"keyword\">if</span> file, err = os.Open(path); err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">           <span class=\"keyword\">return</span></div><div class=\"line\">       &#125;</div><div class=\"line\">       reader := bufio.NewReader(file)</div><div class=\"line\">       buffer := bytes.NewBuffer(<span class=\"built_in\">make</span>([]<span class=\"keyword\">byte</span>, <span class=\"number\">1024</span>))</div><div class=\"line\">       <span class=\"keyword\">for</span> &#123;</div><div class=\"line\">           <span class=\"keyword\">if</span> part, prefix, err = reader.ReadLine(); err != <span class=\"literal\">nil</span> &#123;</div><div class=\"line\">               <span class=\"keyword\">break</span></div><div class=\"line\">           &#125;</div><div class=\"line\">           buffer.Write(part)</div><div class=\"line\">           <span class=\"keyword\">if</span> !prefix &#123;</div><div class=\"line\">               lines = <span class=\"built_in\">append</span>(lines, buffer.String())</div><div class=\"line\">               buffer.Reset()</div><div class=\"line\">           &#125;</div><div class=\"line\">       &#125;</div><div class=\"line\">       <span class=\"keyword\">if</span> err == io.EOF &#123;</div><div class=\"line\">           err = <span class=\"literal\">nil</span></div><div class=\"line\">       &#125;</div><div class=\"line\">       <span class=\"keyword\">return</span></div><div class=\"line\">   &#125;</div></pre></td></tr></table></figure>\n<p>调用的时候，我通过用了大概如下的代码：</p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div><div class=\"line\">6</div><div class=\"line\">7</div><div class=\"line\">8</div><div class=\"line\">9</div><div class=\"line\">10</div><div class=\"line\">11</div></pre></td><td class=\"code\"><pre><div class=\"line\">lines， <span class=\"keyword\">err</span> := readLines(userFile)</div><div class=\"line\"><span class=\"keyword\">if</span> <span class=\"keyword\">err</span> != nil &#123;</div><div class=\"line\">\t<span class=\"built_in\">return</span></div><div class=\"line\">&#125;</div><div class=\"line\"><span class=\"keyword\">for</span> _, <span class=\"keyword\">line</span> := <span class=\"keyword\">range</span> lines &#123;</div><div class=\"line\">\tsqlStr := rawSql % <span class=\"keyword\">line</span></div><div class=\"line\">\t_, <span class=\"keyword\">err</span> = dbConn.Exec(sqlStr)</div><div class=\"line\">\t<span class=\"keyword\">if</span> <span class=\"keyword\">err</span> != nil &#123;</div><div class=\"line\">\t\t<span class=\"built_in\">return</span></div><div class=\"line\">\t&#125;</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>当然它报错了！这样子的错误信息~</p>\n<figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div></pre></td><td class=\"code\"><pre><div class=\"line\">Error <span class=\"number\">1064</span>: You have <span class=\"keyword\">an</span> error <span class=\"keyword\">in</span> your SQL syntax; check <span class=\"keyword\">the</span> manual that corresponds <span class=\"built_in\">to</span> your MySQL server <span class=\"built_in\">version</span> <span class=\"keyword\">for</span> <span class=\"keyword\">the</span> <span class=\"literal\">right</span> syntax <span class=\"built_in\">to</span> use near <span class=\"string\">''</span> <span class=\"keyword\">at</span> <span class=\"built_in\">line</span> <span class=\"number\">1</span></div></pre></td></tr></table></figure>\n<p>通过查阅，我发现这个near ‘’，是的竟然是空的，不像一般的写错sql语句一样是会写明错误信息~<br>瞬间我就神经开始大条了。</p>\n<pre><code>难道我后面写漏了什么？\n怎么可能！\n不，我得先去喝杯水，然后再来看看。\n水果到了，再吃个苹果。\n吃完洗个手-。-\n我觉得没错啊！\nF**k\n</code></pre><h2 id=\"u7ED3_u5C40\"><a href=\"#u7ED3_u5C40\" class=\"headerlink\" title=\"结局\"></a>结局</h2><p>不玩了，之所以我会认为自己没错，是因为我将整个sql语句打印了出来，在肉眼确认没错之后，又去mysql得命令行中直接执行了语句，结果十分顺利。<br>最后，十分大条的将从文件中读取出来的lines用长度打印了出来，瞬间我就斯巴达了！  </p>\n<figure class=\"highlight vim\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\"><span class=\"keyword\">for</span> _, <span class=\"built_in\">line</span> := <span class=\"built_in\">range</span> lines &#123;</div><div class=\"line\">\tfmt.Printf(<span class=\"string\">\"len[%s] is %d\"</span>, <span class=\"built_in\">line</span>, <span class=\"built_in\">len</span>(<span class=\"built_in\">line</span>))</div><div class=\"line\">\tsqlStr := rawSql % <span class=\"built_in\">line</span></div><div class=\"line\">\tfmt.Printf(<span class=\"string\">\"sqlStr[%s] is %d\"</span>, <span class=\"built_in\">line</span>, <span class=\"built_in\">len</span>(sqlStr))</div><div class=\"line\">&#125;</div></pre></td></tr></table></figure>\n<p>结果。。。</p>\n<figure class=\"highlight inform7\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div></pre></td><td class=\"code\"><pre><div class=\"line\">len<span class=\"comment\">[*****]</span> <span class=\"keyword\">is</span> 1024!</div><div class=\"line\">sqlStr<span class=\"comment\">[*****]</span> <span class=\"keyword\">is</span> 1065!</div></pre></td></tr></table></figure>\n<p>这就是为什么我执行失败的原因！sqlStr里面，存在着一段空白的buffer！却是打印不出来的~<br>最后我把代码改成了这样~</p>\n<figure class=\"highlight stata\"><table><tr><td class=\"gutter\"><pre><div class=\"line\">1</div><div class=\"line\">2</div><div class=\"line\">3</div><div class=\"line\">4</div><div class=\"line\">5</div></pre></td><td class=\"code\"><pre><div class=\"line\">data, <span class=\"keyword\">err</span> = ioutil.ReadAll(userFile)</div><div class=\"line\">   <span class=\"keyword\">if</span> <span class=\"keyword\">err</span> != nil &#123;</div><div class=\"line\">\t<span class=\"built_in\">return</span></div><div class=\"line\">&#125;</div><div class=\"line\">lines := strings.<span class=\"keyword\">Split</span>(<span class=\"built_in\">string</span>(data), <span class=\"string\">\"\\n\"</span>)</div></pre></td></tr></table></figure>\n<h2 id=\"Done\"><a href=\"#Done\" class=\"headerlink\" title=\"Done\"></a>Done</h2>"}