{"tags":[{"name":"docker","permalink":"http://catlittlechen.com/tags/docker/","url":"/async/tags/docker.json","count":1}],"categories":[{"name":"docker","permalink":"http://catlittlechen.com/categories/docker/","url":"/async/categories/docker.json","count":1}],"url":"/async/posts/2016/07/22/docker-swarm.json","date":1469199108000,"path":{"year":2016,"month":7,"day":22,"name":"docker-swarm"},"title":"docker-swarm","permalink":"http://catlittlechen.com/2016/07/22/docker-swarm/","content":"<p>前段时间，我和公司的运维朋友一起玩了下docker。在配置docker-swarm的时候，运维朋友可以安逸地开启aws，可怜的我只能默默地在自己的单机上面搭建了~~</p>\n<p>所以，才有了今天在用docker-machine来搭建docker-swarm，这份教程基本是按照docker-swram的官方教程改的~</p>\n<h4 id=\"创建docker-machine\"><a href=\"#创建docker-machine\" class=\"headerlink\" title=\"创建docker-machine\"></a>创建docker-machine</h4><figure class=\"highlight livecodeserver\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker-machine <span class=\"built_in\">create</span> <span class=\"comment\">--driver virtualbox consul</span></span><br><span class=\"line\">docker-machine <span class=\"built_in\">create</span> <span class=\"comment\">--driver virtualbox manager1</span></span><br><span class=\"line\">docker-machine <span class=\"built_in\">create</span> <span class=\"comment\">--driver virtualbox manager2</span></span><br><span class=\"line\">docker-machine <span class=\"built_in\">create</span> <span class=\"comment\">--driver virtualbox node1</span></span><br><span class=\"line\">docker-machine <span class=\"built_in\">create</span> <span class=\"comment\">--driver virtualbox node2</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"配置consul\"><a href=\"#配置consul\" class=\"headerlink\" title=\"配置consul\"></a>配置consul</h4><p>切换到consul虚机里面：</p>\n<figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">eval</span> $(docker-machine <span class=\"keyword\">env</span> consul)</span><br></pre></td></tr></table></figure>\n<p>启动consul服务：</p>\n<figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker <span class=\"builtin-name\">run</span> -d -p 8500:8500 <span class=\"attribute\">--name</span>=consul progrium/consul -server -bootstrap</span><br></pre></td></tr></table></figure>\n<h4 id=\"配置manager节点\"><a href=\"#配置manager节点\" class=\"headerlink\" title=\"配置manager节点\"></a>配置manager节点</h4><p>配置manager1节点：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eval $(docker-machine env manager1)</span><br><span class=\"line\">docker run -d -p <span class=\"number\">4000</span>:<span class=\"number\">4000</span> -v <span class=\"regexp\">/var/</span>lib<span class=\"regexp\">/boot2docker:/</span><span class=\"string\">certs:</span>ro swarm manage -<span class=\"string\">H :</span><span class=\"number\">4000</span> --tlsverify --tlscacert=<span class=\"regexp\">/certs/</span>ca.pem --tlscert=<span class=\"regexp\">/certs/</span>server.pem --tlskey=<span class=\"regexp\">/certs/</span>server-key.pem --replication --advertise $(docker-machine ip manager1):<span class=\"number\">4000</span> <span class=\"string\">consul:</span><span class=\"comment\">//$(docker-machine ip consul):8500</span></span><br></pre></td></tr></table></figure>\n<p>配置manager2节点：</p>\n<figure class=\"highlight groovy\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eval $(docker-machine env manager2)</span><br><span class=\"line\">docker run -d -p <span class=\"number\">4000</span>:<span class=\"number\">4000</span> -v <span class=\"regexp\">/var/</span>lib<span class=\"regexp\">/boot2docker:/</span><span class=\"string\">certs:</span>ro swarm manage -<span class=\"string\">H :</span><span class=\"number\">4000</span> --tlsverify --tlscacert=<span class=\"regexp\">/certs/</span>ca.pem --tlscert=<span class=\"regexp\">/certs/</span>server.pem --tlskey=<span class=\"regexp\">/certs/</span>server-key.pem --replication --advertise $(docker-machine ip manager2):<span class=\"number\">4000</span> <span class=\"string\">consul:</span><span class=\"comment\">//$(docker-machine ip consul):8500</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"配置node节点\"><a href=\"#配置node节点\" class=\"headerlink\" title=\"配置node节点\"></a>配置node节点</h4><p>配置node1节点</p>\n<figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">eval</span> $(docker-machine <span class=\"keyword\">env</span> node1)</span><br><span class=\"line\">docker run -d swarm join --advertise=$(docker-machine ip node1):<span class=\"number\">2376</span> consul:<span class=\"comment\">//$(docker-machine ip consul):8500</span></span><br></pre></td></tr></table></figure>\n<p>配置node2节点</p>\n<figure class=\"highlight mel\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">eval</span> $(docker-machine <span class=\"keyword\">env</span> node2)</span><br><span class=\"line\">docker run -d swarm join --advertise=$(docker-machine ip node2):<span class=\"number\">2376</span> consul:<span class=\"comment\">//$(docker-machine ip consul):8500</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"测试\"><a href=\"#测试\" class=\"headerlink\" title=\"测试\"></a>测试</h3><figure class=\"highlight routeros\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker -H :4000 --tlsverify <span class=\"attribute\">--tlscacert</span>=/var/lib/boot2docker/ca.pem <span class=\"attribute\">--tlscert</span>=/var/lib/boot2docker/server.pem <span class=\"attribute\">--tlskey</span>=/var/lib/boot2docker/server-key.pem <span class=\"builtin-name\">run</span> hello-world</span><br></pre></td></tr></table></figure>\n"}